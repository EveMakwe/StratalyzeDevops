name: Deploy to Production

on:
  pull_request:
    branches: [ main ]
  workflow_dispatch:


    
env:
  NAMESPACE: coffee-queue

jobs:
  deploy-prod:
    runs-on: ubuntu-latest
    if: contains(github.event.pull_request.labels.*.name, 'deploy-app') || github.event_name == 'workflow_dispatch'
    environment:
      name: production
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'v1.28.0'
    
    - name: Set up Kind cluster
      uses: helm/kind-action@v1.8.0
      with:
        cluster_name: coffee-queue-prod-cluster
    
    - name: Build Docker image
      run: |
        docker build -t coffee-queue-app:latest ./coffeequeue
    
    - name: Load Docker image to Kind
      run: |
        kind load docker-image coffee-queue-app:latest --name coffee-queue-prod-cluster
    
    - name: Create production namespace
      run: |
        kubectl create namespace ${{ env.NAMESPACE }} --dry-run=client -o yaml | kubectl apply -f -
        kubectl label namespace ${{ env.NAMESPACE }} environment=production --overwrite
    
    - name: Create PostgreSQL secrets
      env:
        POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
        POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
        POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
      run: |
        kubectl create secret generic postgres-secret \
          --from-literal=POSTGRES_DB="$POSTGRES_DB" \
          --from-literal=POSTGRES_USER="$POSTGRES_USER" \
          --from-literal=POSTGRES_PASSWORD="$POSTGRES_PASSWORD" \
          -n ${{ env.NAMESPACE }} \
          --dry-run=client -o yaml | kubectl apply -f -
    
    - name: Deploy PostgreSQL
      run: |
        kubectl apply -f k8s/postgres/configmap.yaml -n ${{ env.NAMESPACE }}
        kubectl apply -f k8s/postgres/pvc.yaml -n ${{ env.NAMESPACE }}
        kubectl apply -f k8s/postgres/deployment.yaml -n ${{ env.NAMESPACE }}
        kubectl apply -f k8s/postgres/service.yaml -n ${{ env.NAMESPACE }}
    
    - name: Wait for PostgreSQL
      run: |
        kubectl wait --for=condition=available --timeout=300s deployment/postgres -n ${{ env.NAMESPACE }}
        echo "PostgreSQL is ready"
    
    - name: Create application secrets
      env:
        POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
        POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
        POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
      run: |
        kubectl create secret generic app-secret \
          --from-literal=SPRING_DATASOURCE_URL="jdbc:postgresql://postgres-service:5432/$POSTGRES_DB" \
          --from-literal=SPRING_DATASOURCE_USERNAME="$POSTGRES_USER" \
          --from-literal=SPRING_DATASOURCE_PASSWORD="$POSTGRES_PASSWORD" \
          -n ${{ env.NAMESPACE }} \
          --dry-run=client -o yaml | kubectl apply -f -
    
    - name: Deploy Application
      run: |
        kubectl apply -f k8s/app/deployment.yaml -n ${{ env.NAMESPACE }}
        kubectl apply -f k8s/app/service.yaml -n ${{ env.NAMESPACE }}
        kubectl apply -f k8s/app/hpa.yaml -n ${{ env.NAMESPACE }}
    
    - name: Wait for Application
      run: |
        kubectl wait --for=condition=available --timeout=300s deployment/coffee-queue-app -n ${{ env.NAMESPACE }}
        echo "Application deployed successfully"
    
    - name: Run smoke tests
      run: |
        kubectl port-forward service/coffee-queue-service 8080:8080 -n ${{ env.NAMESPACE }} &
        PORT_FORWARD_PID=$!
        sleep 10
        curl -f http://localhost:8080/health || exit 1
        curl -f -X POST "http://localhost:8080/order?name=TestUser" || exit 1
        kill $PORT_FORWARD_PID 2>/dev/null || true
        echo "All tests passed"
    
    - name: Show deployment info
      if: success()
      run: |
        echo "Production deployment successful!"
        echo "Namespace: ${{ env.NAMESPACE }}"
        echo "Access: kubectl port-forward service/coffee-queue-service 8080:8080 -n ${{ env.NAMESPACE }}"
