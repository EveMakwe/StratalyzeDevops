name: Deploy to Development

on:
  push:
    branches: [ develop ]
  pull_request:
    branches: [ develop ]
  workflow_dispatch:


env:
  NAMESPACE: coffee-queue

jobs:
  deploy-dev:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || contains(github.event.pull_request.labels.*.name, 'deploy-app') || github.event_name == 'workflow_dispatch'
    environment:
      name: development
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'v1.28.0'
    
    - name: Set up Kind cluster
      uses: helm/kind-action@v1.8.0
      with:
        cluster_name: coffee-queue-dev-cluster
        wait: 30s
    
    - name: Build Docker image with cache
      run: |
        docker build \
          --cache-from coffee-queue-app:latest \
          --build-arg BUILDKIT_INLINE_CACHE=1 \
          -t coffee-queue-app:latest \
          ./coffeequeue
    
    - name: Load Docker image to Kind
      run: |
        kind load docker-image coffee-queue-app:latest --name coffee-queue-dev-cluster
    
    - name: Create development namespace
      run: |
        kubectl create namespace ${{ env.NAMESPACE }} --dry-run=client -o yaml | kubectl apply -f -
        kubectl label namespace ${{ env.NAMESPACE }} environment=development --overwrite
    
    - name: Create PostgreSQL secrets
      env:
        POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
        POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
        POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
      run: |
        kubectl create secret generic postgres-secret \
          --from-literal=POSTGRES_DB="$POSTGRES_DB" \
          --from-literal=POSTGRES_USER="$POSTGRES_USER" \
          --from-literal=POSTGRES_PASSWORD="$POSTGRES_PASSWORD" \
          -n ${{ env.NAMESPACE }} \
          --dry-run=client -o yaml | kubectl apply -f -
    
    - name: Deploy PostgreSQL
      run: |
    - name: Deploy PostgreSQL
      run: |
        kubectl apply -f k8s/postgres/ -n ${{ env.NAMESPACE }}
    
    - name: Wait for PostgreSQL
      run: |
        kubectl wait --for=condition=available --timeout=180s deployment/postgres -n ${{ env.NAMESPACE }} || \
        (kubectl logs -l app=postgres -n ${{ env.NAMESPACE }} --tail=50 && exit 1)
        echo "✅ PostgreSQL is ready"
    
    - name: Create application secrets
      env:
        POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
        POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
        POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
      run: |
        kubectl create secret generic app-secret \
          --from-literal=SPRING_DATASOURCE_URL="jdbc:postgresql://postgres-service:5432/$POSTGRES_DB" \
          --from-literal=SPRING_DATASOURCE_USERNAME="$POSTGRES_USER" \
          --from-literal=SPRING_DATASOURCE_PASSWORD="$POSTGRES_PASSWORD" \
          -n ${{ env.NAMESPACE }} \
          --dry-run=client -o yaml | kubectl apply -f -
    
    - name: Deploy Application
      run: |
        kubectl apply -f k8s/app/deployment.yaml -n ${{ env.NAMESPACE }}
        kubectl apply -f k8s/app/service.yaml -n ${{ env.NAMESPACE }}
        # HPA is not applied in dev; keep single replica
        kubectl patch deployment coffee-queue-app -n ${{ env.NAMESPACE }} -p '{"spec":{"replicas":1}}'
    
    - name: Wait for Application
      run: |
        kubectl wait --for=condition=available --timeout=180s deployment/coffee-queue-app -n ${{ env.NAMESPACE }} || \
        (kubectl describe pod -l app=coffee-queue-app -n ${{ env.NAMESPACE }} && \
         kubectl logs -l app=coffee-queue-app -n ${{ env.NAMESPACE }} --tail=100 && exit 1)
        echo "✅ Application deployed successfully"
    
    - name: Run smoke tests
      timeout-minutes: 2
      run: |
        kubectl port-forward service/coffee-queue-service 8080:8080 -n ${{ env.NAMESPACE }} &
        PORT_FORWARD_PID=$!
        sleep 5
        
        # Health check
        curl -f http://localhost:8080/health || exit 1
        echo "✅ Health check passed"
        
        # Create order
        ORDER_RESPONSE=$(curl -sf -X POST "http://localhost:8080/order?name=CI-Test-$(date +%s)")
        echo "✅ Order created: $ORDER_RESPONSE"
        
        # Check counts
        curl -f http://localhost:8080/numberOfCoffees
        echo "✅ All smoke tests passed"
        
        kill $PORT_FORWARD_PID 2>/dev/null || true
    
    - name: Show deployment info
      if: success()
      run: |
        echo "## ✅ Development Deployment Successful!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Namespace:** \`${{ env.NAMESPACE }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Access:** \`kubectl port-forward service/coffee-queue-service 8080:8080 -n ${{ env.NAMESPACE }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        kubectl get pods -n ${{ env.NAMESPACE }} >> $GITHUB_STEP_SUMMARY
